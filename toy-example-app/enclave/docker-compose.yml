# dstack Deployment Configuration
#
# This file is used by dstack/Phala Cloud to deploy the enclave.
# The compose hash is included in the TEE attestation, creating a
# verifiable link between source code and running enclave.
#
# IMPORTANT: Any change to this file changes the compose hash,
# which requires re-attestation and transparency log update.

version: "3.8"

services:
  enclave:
    # Image tag is updated by CI/CD with the git commit SHA
    image: ghcr.io/xordi/toy-example-enclave:latest
    ports:
      - "8080:8080"
    volumes:
      # dstack socket for TEE attestation
      - /var/run/dstack.sock:/var/run/dstack.sock
    environment:
      - NODE_ENV=production
      - PORT=8080
      # These are injected via CLI -e flags or secrets
      - MOCK_API_URL=${MOCK_API_URL}
      - MOCK_API_TOKEN=${MOCK_API_TOKEN}
      - SIGNING_KEY=${SIGNING_KEY}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# dstack-specific configuration
# These settings control TEE deployment behavior
x-dstack:
  # KMS for on-chain transparency logging
  kms: base
  # Resource allocation
  resources:
    memory: 512Mi
    cpu: 0.5
  # Note: Cluster/node selection is done via --node-id in CI/CD
  # to ensure same compose hash across all deployments
